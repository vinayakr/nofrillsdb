<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter nofrillsdb.backend>
  @type parser
  key_name log
  reserve_data true
  hash_value_field log
  <parse>
    @type json
  </parse>
</filter>

<match nofrillsdb.backend>
  @type sumologic
  endpoint "#{ENV['ENDPOINT']}"
  log_format json
  source_category backend
  source_host nofrillsdb.com
  source_name nofrillsdb-backend
  <buffer>
    @type memory
    chunk_limit_size 1m
    flush_interval 10s
  </buffer>
</match>

<match nofrillsdb.frontend>
  @type sumologic
  endpoint "#{ENV['ENDPOINT']}"
  log_format json
  source_category frontend
  source_host nofrillsdb.com
  source_name nofrillsdb-frontend
  <buffer>
    @type memory
    chunk_limit_size 1m
    flush_interval 10s
  </buffer>
</match>

<filter nofrillsdb.database>
  @type parser
  key_name log
  reserve_data true
  <parse>
    @type regexp
    expression /^(?<time>[\d-]+\s[\d:.]+)\s(?<timezone>\w+)\s\[(?<pid>\d+)\]\s(?<level>\w+):\s(?<message>.*)$/
    time_key time
    time_format %Y-%m-%d %H:%M:%S.%L
  </parse>
</filter>

<match nofrillsdb.database>
  @type sumologic
  endpoint "#{ENV['ENDPOINT']}"
  log_format json
  source_category database
  source_host nofrillsdb.com
  source_name nofrillsdb-database
  <buffer>
    @type memory
    chunk_limit_size 1m
    flush_interval 5s
  </buffer>
</match>

<filter provision.pg_bouncer>
  @type record_transformer
  enable_ruby true
  <record>
    service "pgbouncer"
    environment "prod"
  </record>
</filter>


<match provision.pg_bouncer>
  @type sumologic
  endpoint "#{ENV['ENDPOINT']}"
  log_format text
  source_category pgbouncer
  source_host nofrillsdb.com
  source_name nofrillsdb-pgbouncer

  <buffer>
    @type memory
    chunk_limit_size 1m
    flush_interval 10s
  </buffer>
</match>

